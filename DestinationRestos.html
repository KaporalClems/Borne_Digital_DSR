<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destination Restos - Sud Réunion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        :root {
            --theme-color-dark: #8c2d04; /* Un brun-rouge pour la gastronomie */
            --theme-color-light: #d97706; /* Un orange ambré */
            --theme-white: #ffffff;
        }
        .bg-theme-dark { background-color: var(--theme-color-dark); }
        .text-theme-light { color: var(--theme-color-light); }
        .ring-theme-light:focus { ring-color: var(--theme-color-light); }
        .hover-bg-theme-dark:hover { background-color: var(--theme-color-dark); }

        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        #fullscreen-carousel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: -1;
        }
        #fullscreen-carousel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Assombri un peu plus pour la lisibilité */
            z-index: 1;
        }
        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 0;
        }
        .carousel-item.active {
            opacity: 1;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #map {
            height: 500px;
            border-radius: 0.5rem;
        }
        .cuisine-icon {
            width: 1.25rem;
            height: 1.25rem;
        }
        .payment-icon {
            width: 1.5rem;
            height: 1.5rem;
            color: #4a4a4a;
        }
        
        .animate-title {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUP 1s ease-out 0.5s forwards;
        }
        @keyframes fadeInUP {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Styles pour la modale */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-hidden {
            pointer-events: none;
            opacity: 0;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .modal-hidden .modal-content {
            transform: scale(0.95);
        }

        /* Styles pour les popups de la carte */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 12px !important;
        }
        .popup-cuisine-icon {
            width: 1rem;
            height: 1rem;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--theme-color-dark);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Carrousel en fond d'écran -->
    <section id="fullscreen-carousel">
        <div class="carousel-item active"><img src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?q=80&w=1974&auto=format&fit=crop" alt="Ambiance de restaurant 1"></div>
        <div class="carousel-item"><img src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=2070&auto=format&fit=crop" alt="Ambiance de restaurant 2"></div>
        <div class="carousel-item"><img src="https://images.unsplash.com/photo-1578474846511-04ba529f0b88?q=80&w=1974&auto=format&fit=crop" alt="Plat gastronomique 3"></div>
    </section>

    <!-- Contenu de la page -->
    <div class="relative z-10">
        <header class="bg-theme-dark/70 backdrop-blur-sm shadow-md sticky top-0">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-bold text-white">Destination <span class="text-theme-light">Restos</span></div>
                <div>
                    <a href="#" class="text-gray-200 hover:text-white px-3 py-2">Accueil</a>
                    <a href="#" class="text-gray-200 hover:text-white px-3 py-2">Restaurants</a>
                    <a href="#" class="text-gray-200 hover:text-white px-3 py-2">Contact</a>
                </div>
            </nav>
        </header>

        <div class="h-[calc(100vh-68px)] flex flex-col items-center justify-center text-white text-center px-4">
            <h1 class="text-5xl md:text-7xl font-black uppercase animate-title" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">Savourez le Sud</h1>
            <p class="mt-4 text-lg md:text-xl max-w-2xl animate-title" style="animation-delay: 0.7s; text-shadow: 1px 1px 4px rgba(0,0,0,0.7);">Découvrez les meilleures tables du Sud de l'île intense.</p>
            <a href="#filters" class="mt-8 animate-bounce"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10"><path stroke-linecap="round" stroke-linejoin="round" d="m9 12.75 3 3m0 0 3-3m-3 3v-7.5" /></svg></a>
        </div>

        <main class="container mx-auto px-6 py-8 bg-f0f4f8" id="content-start">
            <section id="filters" class="mb-12 p-6 bg-white rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-theme-dark text-center">Trouvez votre prochain restaurant</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <input type="text" id="searchInput" placeholder="Nom du restaurant..." class="lg:col-span-2 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 ring-theme-light">
                    <!-- Les filtres de prix et de note sont désactivés car ces données ne sont pas présentes dans le JSON fourni -->
                    <select id="priceFilter" class="hidden p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 ring-theme-light">
                        <option value="all">Tous les prix</option>
                    </select>
                    <select id="ratingFilter" class="hidden p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 ring-theme-light">
                        <option value="all">Toutes les notes</option>
                    </select>
                    <select id="communeFilter" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 ring-theme-light"><option value="all">Toute commune</option></select>
                </div>
                <div class="mt-4"><select id="cuisineFilter" class="p-3 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 ring-theme-light"><option value="all">Toutes les cuisines</option></select></div>
            </section>

            <!-- Disposition : Carte puis Grille de restaurants -->
            <div class="space-y-8">
                <div class="bg-white p-4 rounded-lg shadow-xl"><h3 class="text-xl font-bold mb-4 text-theme-dark">Carte des restaurants</h3><div id="map"></div></div>
                <div><div id="restaurants-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
            </div>
        </main>

        <footer class="bg-theme-dark text-white text-center p-4 mt-12"><p>&copy; Destination Sud Réunion 2025</p></footer>
    </div>

    <!-- Modale pour les détails du restaurant -->
    <div id="details-modal" class="modal modal-hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-lg shadow-2xl m-4 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div id="modal-body">
                <!-- Contenu injecté par JS -->
            </div>
        </div>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-theme-dark text-lg">Chargement des données...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const restaurantsList = document.getElementById('restaurants-list');
            const searchInput = document.getElementById('searchInput');
            const communeFilter = document.getElementById('communeFilter');
            const cuisineFilter = document.getElementById('cuisineFilter');
            const modal = document.getElementById('details-modal');
            const modalBody = document.getElementById('modal-body');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // --- VARIABLES GLOBALES ---
            let allRestaurants = [];
            let map;
            let restaurantMarkers = {};
            const placeholderImage = 'https://placehold.co/600x400/CCCCCC/333333?text=Image+non+disponible';
            const placeholderDescription = 'Aucune description disponible pour ce restaurant.';

            const cuisineIcons = {
                'Créole': `<svg class="cuisine-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.26 11.77C17.26 10.34 16.1 9.18 14.67 9.18C13.24 9.18 12.08 10.34 12.08 11.77C12.08 13.13 13.13 14.21 14.5 14.37V19.38C14.5 19.93 14.95 20.38 15.5 20.38C16.05 20.38 16.5 19.93 16.5 19.38V9.75C17.63 9.75 18.55 8.83 18.55 7.75C18.55 6.67 17.63 5.75 16.5 5.75H8.5C7.37 5.75 6.45 6.67 6.45 7.75C6.45 8.83 7.37 9.75 8.5 9.75V19.38C8.5 19.93 8.95 20.38 9.5 20.38C10.05 20.38 10.5 19.93 10.5 19.38V14.37C11.87 14.21 12.92 13.13 12.92 11.77C12.92 10.34 11.76 9.18 10.33 9.18C8.9 9.18 7.74 10.34 7.74 11.77C7.74 13.2 8.9 14.36 10.33 14.36C10.37 14.36 10.4 14.36 10.44 14.36C10.48 14.36 10.51 14.36 10.55 14.36V19.38H14.45V14.36C14.49 14.36 14.52 14.36 14.56 14.36C14.6 14.36 14.63 14.36 14.67 14.36C16.1 14.36 17.26 13.2 17.26 11.77Z"/></svg>`,
                'Restauration': `<svg class="cuisine-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.69 2 6 4.69 6 8V16C6 19.31 8.69 22 12 22C15.31 22 18 19.31 18 16V8C18 4.69 15.31 2 12 2M12 4C14.21 4 16 5.79 16 8V16C16 18.21 14.21 20 12 20C9.79 20 8 18.21 8 16V8C8 5.79 9.79 4 12 4M12 10C10.9 10 10 10.9 10 12C10 13.11 10.9 14 12 14C13.11 14 14 13.11 14 12C14 10.9 13.11 10 12 10Z"/></svg>`,
                'Défaut': `<svg class="cuisine-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>`
            };

            const paymentIcons = {
                'Visa': `<svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.84 9.17H18.73V7.63H20.66C21.14 7.63 21.5 7.27 21.5 6.79C21.5 6.31 21.14 5.95 20.66 5.95H17.72C16.94 5.95 16.3 6.6 16.3 7.37V16.7C16.3 17.47 16.94 18.11 17.72 18.11H20.84C21.62 18.11 22.26 17.47 22.26 16.7V9.17H22.84C23.32 9.17 23.68 8.81 23.68 8.33C23.68 7.85 23.32 7.49 22.84 7.49H22.42V7.12C22.42 6.64 22.06 6.28 21.58 6.28H19.65C19.17 6.28 18.81 6.64 18.81 7.12V8.14H22.84C23.32 8.14 23.68 8.5 23.68 8.98C23.68 9.46 23.32 9.82 22.84 9.82H22.42V16.7C22.42 17.47 21.78 18.11 21 18.11H17.84C17.06 18.11 16.42 17.47 16.42 16.7V7.12C16.42 6.34 17.06 5.7 17.84 5.7H20.86C21.64 5.7 22.28 6.34 22.28 7.12V9.17H22.84Z"/><path d="M12.92 10.94L11.74 15.65H10.16L11.35 10.94H12.92Z"/><path d="M14.99 15.65H13.62L12.44 10.94H13.81L14.99 15.65Z"/><path d="M8.28 15.65H6.91L5.73 10.94H7.1L8.28 15.65Z"/><path d="M5.4 15.65H4.02L2.84 10.94H4.22L5.4 15.65Z"/><path d="M11.08 17.18H9.71L8.53 12.47H9.9L11.08 17.18Z"/><path d="M12.99 15.65H11.62L10.44 10.94H11.81L12.99 15.65Z"/><path d="M1.37 15.65H0L1.18 10.94H2.55L1.37 15.65Z"/><path d="M4.68 17.18H3.31L2.13 12.47H3.5L4.68 17.18Z"/><path d="M10.74 15.65H9.37L8.19 10.94H9.56L10.74 15.65Z"/><path d="M14.99 15.65H13.62L12.44 10.94H13.81L14.99 15.65Z"/><path d="M2.31 17.18H0.94L-0.24 12.47H1.13L2.31 17.18Z"/></svg>`,
                'Chèque': `<svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 17C22 18.11 21.11 19 20 19H4C2.9 19 2 18.11 2 17V7C2 5.9 2.9 5 4 5H20C21.11 5 22 5.9 22 7V17M10 9H6V7H10V9M18 9H12V7H18V9M18 13H12V11H18V13M10 13H6V11H10V13M18 17H12V15H18V17M10 17H6V15H10V17Z"/></svg>`,
                'Ticket restaurant': `<svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.69 2 6 4.69 6 8V16C6 19.31 8.69 22 12 22C15.31 22 18 19.31 18 16V8C18 4.69 15.31 2 12 2M12 4C14.21 4 16 5.79 16 8V16C16 18.21 14.21 20 12 20C9.79 20 8 18.21 8 16V8C8 5.79 9.79 4 12 4M12 10C10.9 10 10 10.9 10 12C10 13.11 10.9 14 12 14C13.11 14 14 13.11 14 12C14 10.9 13.11 10 12 10Z"/></svg>`,
                'Espèces': `<svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6H4C2.9 6 2 6.9 2 8V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6M20 8V18H4V8H20M12 11C13.66 11 15 12.34 15 14S13.66 17 12 17 9 15.66 9 14 10.34 11 12 11M12 13C11.45 13 11 13.45 11 14S11.45 15 12 15 13 14.55 13 14 12.55 13 12 13Z"/></svg>`,
                'Défaut': `<svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.25V18m6-2.25V18m.5-12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12 6a.75.75 0 100 1.5.75.75 0 000-1.5zM3.75 6.75h16.5M3.75 18.75h16.5m-16.5-12V18M7.5 6.75v12M16.5 6.75v12M20.25 6.75V18" /></svg>`
            };
            
            // --- FONCTION POUR CHARGER LES DONNÉES DE PLUSIEURS SOURCES ---
            async function fetchAllRestaurants() {
                loadingOverlay.style.display = 'flex';
                // URLs des fichiers JSON sur GitHub
                const filePaths = [
                    "https://raw.githubusercontent.com/KaporalClems/Borne_Digital_DSR/refs/heads/main/restaurants-saintpierre.json",
                    "https://raw.githubusercontent.com/KaporalClems/Borne_Digital_DSR/refs/heads/main/restaurants-saintlouis.json",
                    "https://raw.githubusercontent.com/KaporalClems/Borne_Digital_DSR/refs/heads/main/restaurants-letangsale.json",
                    "https://raw.githubusercontent.com/KaporalClems/Borne_Digital_DSR/refs/heads/main/restaurants-lesavirons.json",
                    "https://raw.githubusercontent.com/KaporalClems/Borne_Digital_DSR/refs/heads/main/restaurants-petiteile.json"
                ];
                
                let combinedData = [];
                
                try {
                    const promises = filePaths.map(path => 
                        fetch(path).then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status} for file: ${path}`);
                            }
                            return response.json();
                        })
                    );
                    const results = await Promise.all(promises);
                    // Accéder au tableau 'results' dans chaque objet JSON avant de les fusionner
                    combinedData = results.flatMap(data => data.results);
                    return combinedData;
                } catch (error) {
                    console.error("Erreur lors du chargement des données :", error);
                    restaurantsList.innerHTML = `<p class="text-red-500 text-center col-span-full">Une erreur est survenue lors du chargement des restaurants. Veuillez réessayer plus tard.</p>`;
                    return [];
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function createRestaurantCard(resto) {
                const restoCard = document.createElement('div');
                restoCard.className = `card bg-white rounded-lg shadow-lg overflow-hidden flex flex-col`;
                
                // Utilisation des nouvelles clés du JSON
                const name = resto.nom_commercial;
                const cuisine = resto.type?.[0] || 'Défaut'; // Utiliser le premier type ou un défaut
                const commune = resto.commune;
                const lat = resto.coordonnees_geographiques?.lat;
                const lon = resto.coordonnees_geographiques?.lon;

                const cuisineIconHtml = cuisineIcons[cuisine] || cuisineIcons['Défaut'];
                const price = resto.prix || 'N/A'; // Gestion des données manquantes
                const rating = resto.note || 'N/A'; // Gestion des données manquantes

                restoCard.innerHTML = `
                    <img src="${resto.image || placeholderImage}" alt="Image de ${name}" class="w-full h-32 object-cover cursor-pointer">
                    <div class="p-3 flex flex-col flex-grow">
                        <h3 class="text-base font-bold mb-1 text-theme-dark cursor-pointer">${name}</h3>
                        <div class="flex items-center text-xs text-gray-600 mb-2">
                            ${rating !== 'N/A' ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                            <span>${rating}</span>` : ''}
                            <span class="mx-2">|</span>
                            <span class="font-bold text-lg text-gray-800">${price}</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-500">${cuisineIconHtml}</div>
                        <div class="mt-auto pt-3 flex justify-end">
                            <button class="info-btn text-xs bg-gray-600 text-white font-semibold px-3 py-1 rounded-full hover-bg-theme-dark transition-colors">+ d'infos</button>
                        </div>
                    </div>`;
                
                // Vérifier si les coordonnées sont valides avant d'ajouter les événements
                if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                    restoCard.querySelector('img').addEventListener('click', () => {
                        map.setView([lat, lon], 14);
                        restaurantMarkers[name]?.openPopup();
                    });
                    restoCard.querySelector('h3').addEventListener('click', () => {
                        map.setView([lat, lon], 14);
                        restaurantMarkers[name]?.openPopup();
                    });
                }
                
                restoCard.querySelector('.info-btn').addEventListener('click', () => showDetailsModal(resto));
                return restoCard;
            }

            function displayRestaurants(filteredRestos) {
                restaurantsList.innerHTML = '';
                Object.values(restaurantMarkers).forEach(marker => map.removeLayer(marker));
                restaurantMarkers = {}; 
                
                if (filteredRestos.length === 0) {
                    restaurantsList.innerHTML = `<p class="text-gray-500 text-center col-span-full">Aucun restaurant ne correspond à votre recherche.</p>`;
                    return;
                }

                filteredRestos.forEach(resto => {
                    restaurantsList.appendChild(createRestaurantCard(resto));
                    const lat = resto.coordonnees_geographiques?.lat;
                    const lon = resto.coordonnees_geographiques?.lon;
                    
                    if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                        const cuisine = resto.type?.[0] || 'Défaut';
                        const cuisineIconHtmlPopup = (cuisineIcons[cuisine] || cuisineIcons['Défaut']).replace('cuisine-icon', 'popup-cuisine-icon');
                        const popupContent = `
                            <div class="font-sans text-gray-800 w-56">
                                <h3 class="font-bold text-base mb-2">${resto.nom_commercial}</h3>
                                <p class="mb-2"><span class="font-semibold text-lg">${resto.prix || 'N/A'}</span> ${resto.note ? `<span class="text-yellow-500">★</span> ${resto.note}` : ''}</p>
                                <div class="flex flex-wrap gap-2 items-center">${cuisineIconHtmlPopup}</div>
                            </div>`;
                        const marker = L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
                        restaurantMarkers[resto.nom_commercial] = marker;
                    }
                });
            }

            // --- FONCTION POUR GÉRER LA MODALE DES DÉTAILS ---
            function showDetailsModal(resto) {
                const cuisine = resto.type?.[0] || 'Défaut';
                const cuisineIconHtml = (cuisineIcons[cuisine] || cuisineIcons['Défaut']);
                const adresse = resto.adresse || 'Adresse non disponible';
                
                // Générer les icônes de paiement
                const paymentModes = resto.modes_de_paiement || [];
                let paymentIconsHtml = '';
                if (paymentModes.length > 0) {
                    paymentIconsHtml = `
                        <h3 class="font-bold text-theme-dark mb-2 mt-4">Modes de paiement</h3>
                        <div class="flex flex-wrap gap-4 text-gray-600">
                            ${paymentModes.map(mode => {
                                const iconSvg = paymentIcons[mode] || paymentIcons['Défaut'];
                                return `<div class="flex items-center gap-2" title="${mode}">${iconSvg}<span>${mode}</span></div>`;
                            }).join('')}
                        </div>
                    `;
                }

                modalBody.innerHTML = `
                    <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center z-20">
                        <h2 class="text-2xl font-bold text-theme-dark">${resto.nom_commercial}</h2>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="p-6">
                        <img src="${resto.image || placeholderImage}" onerror="this.onerror=null;this.src='${placeholderImage}';" alt="Image de ${resto.nom_commercial}" class="w-full h-64 object-cover rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                            <div class="bg-gray-100 p-2 rounded-lg"><div class="font-bold">Prix</div><div>${resto.prix || 'N/A'}</div></div>
                            <div class="bg-gray-100 p-2 rounded-lg"><div class="font-bold">Note</div><div class="flex items-center justify-center">${resto.note ? `<span class="text-yellow-500">★</span>&nbsp;${resto.note}` : 'N/A'}</div></div>
                            <div class="bg-gray-100 p-2 rounded-lg"><div class="font-bold">Commune</div><div>${resto.commune}</div></div>
                        </div>
                        <p class="text-gray-700 mb-4">${resto.description || placeholderDescription}</p>
                        <h3 class="font-bold text-theme-dark mb-2">Type d'établissement</h3>
                        <div class="flex flex-wrap gap-4 mb-4 text-gray-600">
                            <div class="flex items-center gap-2" title="${cuisine}">${cuisineIconHtml}<span>${cuisine}</span></div>
                        </div>
                        <h3 class="font-bold text-theme-dark mb-2">Localisation</h3>
                        <p class="text-gray-600 bg-gray-100 p-3 rounded-lg">${adresse}</p>
                        ${paymentIconsHtml}
                    </div>`;
                modal.classList.remove('modal-hidden');
                document.getElementById('close-modal').addEventListener('click', () => modal.classList.add('modal-hidden'));
            }

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.add('modal-hidden');
            });
            
            // --- FONCTIONS DE FILTRAGE ET D'INITIALISATION ---
            function populateFilters() {
                const allCommunes = new Set();
                const allCuisines = new Set();
                allRestaurants.forEach(resto => {
                    allCommunes.add(resto.commune);
                    resto.type.forEach(t => allCuisines.add(t)); // Le type est un tableau
                });
                [...allCommunes].sort().forEach(commune => communeFilter.appendChild(new Option(commune, commune)));
                [...allCuisines].sort().forEach(cuisine => cuisineFilter.appendChild(new Option(cuisine, cuisine)));
            }

            function filterRestaurants() {
                const searchTerm = searchInput.value.toLowerCase();
                const commune = communeFilter.value;
                const cuisine = cuisineFilter.value;
                const filtered = allRestaurants.filter(resto => {
                    const nameMatch = resto.nom_commercial.toLowerCase().includes(searchTerm);
                    const communeMatch = (commune === 'all') || (resto.commune === commune);
                    const cuisineMatch = (cuisine === 'all') || (resto.type && resto.type.includes(cuisine));
                    return nameMatch && communeMatch && cuisineMatch;
                });
                displayRestaurants(filtered);
            }

            // --- INITIALISATION DE L'APPLICATION ---
            async function initializeApp() {
                allRestaurants = await fetchAllRestaurants();
                if (allRestaurants.length > 0) {
                    const reunionBounds = L.latLngBounds(L.latLng(-21.5, 55.1), L.latLng(-20.8, 56.0));
                    map = L.map('map', { center: [-21.28, 55.55], zoom: 10, maxBounds: reunionBounds, minZoom: 9 });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Leaflet | &copy; OpenStreetMap contributors' }).addTo(map);
                    
                    populateFilters();
                    displayRestaurants(allRestaurants);

                    [searchInput, communeFilter, cuisineFilter].forEach(el => el.addEventListener('change', filterRestaurants));
                    searchInput.addEventListener('input', filterRestaurants);
                }
            }

            // --- CARROUSEL ---
            const carouselItems = document.querySelectorAll('.carousel-item');
            let currentItem = 0;
            setInterval(() => {
                carouselItems[currentItem].classList.remove('active');
                currentItem = (currentItem + 1) % carouselItems.length;
                carouselItems[currentItem].classList.add('active');
            }, 5000);

            initializeApp();
        });
    </script>
</body>
</html>

