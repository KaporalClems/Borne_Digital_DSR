<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Code Postaux DSR</title>
    <style>
        body { font-family: 'Inter', Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background-color: #f0f2f5; color: #333; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        input, button, select { padding: 12px; margin: 8px 0; font-size: 16px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        button:hover { background-color: #45a049; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        #dashboard { display: none; margin-top: 20px; }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        h1 { font-size: 2.5em; margin-bottom: 0.5em; }
        h2 { font-size: 1.8em; margin-top: 1.5em; margin-bottom: 0.8em; }
        .stats-container { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0; }
        .stat-box { flex: 1; min-width: 150px; padding: 20px; border-radius: 12px; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 10px; text-align: center; transition: transform 0.3s ease; }
        .stat-box:hover { transform: translateY(-5px); }
        .stat-box h3 { margin-top: 0; color: #34495e; font-size: 1.2em; }
        .stat-box p { font-size: 2em; font-weight: bold; color: #4CAF50; margin: 5px 0 0; }
        .kpi-container { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0; }
        .kpi-box { flex: 1; min-width: 200px; padding: 20px; border-radius: 12px; background-color: #e8f5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 10px; text-align: center; }
        .kpi-box h4 { margin: 0; color: #2e7d32; font-size: 1.1em; }
        .kpi-box p { font-size: 1.8em; font-weight: bold; color: #1b5e20; margin: 5px 0 0; }
        #villes-stats { text-align: left; }
        #villes-stats ul { list-style: none; padding: 0; }
        #villes-stats li { padding: 8px 0; border-bottom: 1px dotted #ccc; }
        #villes-stats li:last-child { border-bottom: none; }
        .chart-section { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 30px; }
        .chart-box { width: 100%; max-width: 450px; margin: 10px; padding: 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .chart-canvas-wrapper { height: 400px; position: relative; }
        #listeCodes { list-style: none; padding: 0; }
        #listeCodes li { padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        #listeCodes li:last-child { border-bottom: none; }
        .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
        .pagination button { width: auto; margin: 0 5px; background-color: #f0f0f0; color: #333; }
        .pagination button:hover { background-color: #e0e0e0; }
        .pagination button.active { background-color: #4CAF50; color: white; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Dashboard Codes Postaux</h1>

        <!-- Formulaire de connexion -->
        <div id="loginDiv">
            <h2>Connexion</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Mot de passe">
            <button onclick="login()"><i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i> Se connecter</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="exporterEnPDF()" style="width: 32%;"><i class="fas fa-file-pdf" style="margin-right: 8px;"></i> Exporter en PDF</button>
                <button onclick="exporterEnCSV()" style="width: 32%; background-color: #3498db;"><i class="fas fa-file-csv" style="margin-right: 8px;"></i> Exporter en CSV</button>
                <button onclick="logout()" style="width: 32%; background-color: #dc3545;"><i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Se déconnecter</button>
            </div>
            
            <hr>
            
            <h2>Filtres</h2>
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;">
                <div style="flex: 1; min-width: 45%;">
                    <label for="startDate">Date de début:</label>
                    <input type="date" id="startDate" onchange="filterByDate()">
                </div>
                <div style="flex: 1; min-width: 45%;">
                    <label for="endDate">Date de fin:</label>
                    <input type="date" id="endDate" onchange="filterByDate()">
                </div>
            </div>
            <select id="sourceFilter" onchange="filterBySource(this.value)" style="margin-bottom: 20px;">
                <option value="all">Toutes les sources</option>
                <option value="borne_st_pierre">Borne Saint-Pierre</option>
                <option value="borne_etang_sale">Borne L'Étang-Salé</option>
                <option value="tablette">Tablette</option>
            </select>

            <h2>Indicateurs Clés</h2>
            <div class="kpi-container">
                <div class="kpi-box">
                    <h4>Total des Saisies</h4>
                    <p id="totalCount"></p>
                </div>
                <div class="kpi-box">
                    <h4>Villes Uniques</h4>
                    <p id="uniqueCitiesCount"></p>
                </div>
                <div class="kpi-box">
                    <h4>Taux de Complétude</h4>
                    <p id="completenessRate"></p>
                </div>
            </div>

            <hr>
            
            <!-- Section des statistiques par source (masquée par défaut) -->
            <div id="sourceStatsSection" style="display: none;">
                <h2>Statistiques par Source</h2>
                <div class="kpi-container">
                    <div class="kpi-box">
                        <h4>Saisies Borne St-Pierre</h4>
                        <p id="stPierreCount"></p>
                    </div>
                    <div class="kpi-box">
                        <h4>Saisies Borne L'Étang-Salé</h4>
                        <p id="etangSaleCount"></p>
                    </div>
                    <div class="kpi-box">
                        <h4>Saisies Tablettes</h4>
                        <p id="tabletteCount"></p>
                    </div>
                </div>
            </div>
            
            <div class="chart-section">
                <div class="chart-box">
                    <h2>Évolution des Saisies</h2>
                    <label for="viewSelector">Afficher par :</label>
                    <select id="viewSelector" onchange="updateChart('saisiesChart', this.value)">
                        <option value="day">Jour</option>
                        <option value="month">Mois</option>
                        <option value="year">Année</option>
                    </select>
                    <div class="chart-canvas-wrapper">
                      <canvas id="saisiesChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h2>Répartition par Villes</h2>
                    <div class="chart-canvas-wrapper">
                      <canvas id="villesChart"></canvas>
                    </div>
                </div>
                <!-- Graphique de répartition par source (masqué par défaut) -->
                <div class="chart-box" id="sourceChartBox" style="display: none;">
                    <h2>Répartition par Source</h2>
                    <div class="chart-canvas-wrapper">
                      <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <hr>

            <div id="villes-stats">
                <h2>Statistiques par Villes</h2>
                <ul id="villes-stats-list"></ul>
            </div>

            <hr>

            <h2>Derniers codes postaux enregistrés</h2>
            <ul id="listeCodes"></ul>
            <div class="pagination">
                <button id="prevPage" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                <span id="pageInfo"></span>
                <button id="nextPage" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        
        // Import jsPDF pour l'exportation
        import 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        import 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js';
        
        // Import Chart.js pour les graphiques
        import 'https://cdn.jsdelivr.net/npm/chart.js';
        
        // Import pour les icônes
        import 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js';

        // Configuration de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy3tI-gl_z0JzA7uH6bQtMc89pfFcgJMs",
            authDomain: "code-postaux-dsr.firebaseapp.com",
            projectId: "code-postaux-dsr",
            storageBucket: "code-postaux-dsr.firebasestorage.app",
            messagingSenderId: "317015321347",
            appId: "1:317015321347:web:27a95ea854064b21561736",
            measurementId: "G-25B25N3GP9"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let allRawCodes = []; // All data from the database
        let allCodes = [];    // Filtered data for display
        let myCombinedChart, myPieChart, myDoughnutChart;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSourceFilter = 'all';
        let currentStartDate = null;
        let currentEndDate = null;

        // --- Initialise les dates de filtre par défaut (30 derniers jours) ---
        function initializeDateFilters() {
            const endDateInput = document.getElementById('endDate');
            const startDateInput = document.getElementById('startDate');
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            endDateInput.value = endDate.toISOString().split('T')[0];
            startDateInput.value = startDate.toISOString().split('T')[0];
            
            currentStartDate = startDate;
            currentEndDate = endDate;
        }

        // --- Fonctions d'authentification ---
        window.login = async function() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                console.error("Erreur de connexion :", err.message);
                alert("Erreur de connexion : " + err.message);
            }
        }
        
        window.logout = async function() {
            await signOut(auth);
        }

        // --- Gestion de l'état d'authentification et chargement initial ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById("loginDiv").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                
                // Initialise les filtres de date par défaut
                initializeDateFilters();
                
                const q = query(collection(db, "codesPostaux"), orderBy("date", "desc"));
                
                // Listen to database changes
                onSnapshot(q, (snapshot) => {
                    allRawCodes = snapshot.docs.map(doc => doc.data());
                    
                    // Initially apply all filters
                    applyFilters();
                });
            } else {
                document.getElementById("loginDiv").style.display = "block";
                document.getElementById("dashboard").style.display = "none";
            }
        });

        // --- Filter functions ---
        window.filterBySource = function(source) {
            currentSourceFilter = source;
            applyFilters();
        }
        
        window.filterByDate = function() {
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;
            
            currentStartDate = startDateValue ? new Date(startDateValue) : null;
            currentEndDate = endDateValue ? new Date(endDateValue) : null;
            
            applyFilters();
        }
        
        function applyFilters() {
            let filteredData = [...allRawCodes];
            
            // Filter by source
            if (currentSourceFilter !== 'all') {
                filteredData = filteredData.filter(c => c.source === currentSourceFilter);
            }
            
            // Filter by date range
            if (currentStartDate && currentEndDate) {
                // Adjust end date to include the full day
                const adjustedEndDate = new Date(currentEndDate);
                adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                
                filteredData = filteredData.filter(c => {
                    const date = c.date?.toDate();
                    return date >= currentStartDate && date < adjustedEndDate;
                });
            }
            
            allCodes = filteredData;
            
            // Affiche/Masque les statistiques et le graphique par source
            const sourceStatsSection = document.getElementById('sourceStatsSection');
            const sourceChartBox = document.getElementById('sourceChartBox');
            if (currentSourceFilter === 'all' && (!currentStartDate || !currentEndDate)) {
                sourceStatsSection.style.display = 'block';
                sourceChartBox.style.display = 'block';
            } else {
                sourceStatsSection.style.display = 'none';
                sourceChartBox.style.display = 'none';
            }
            
            // Reset page to 1 on filter change
            currentPage = 1;
            mettreAJourUI();
        }

        // --- Mise à jour de l'UI avec les données ---
        function mettreAJourUI() {
            // Mise à jour des KPI
            const uniqueCitiesCount = new Set(allCodes.map(c => c.ville)).size;
            
            const totalCount = allCodes.length;
            const validCount = allCodes.filter(c => c.code && c.ville).length;
            const completenessRate = totalCount > 0 ? ((validCount / totalCount) * 100).toFixed(1) : 0;

            document.getElementById("totalCount").textContent = totalCount;
            document.getElementById("uniqueCitiesCount").textContent = uniqueCitiesCount;
            document.getElementById("completenessRate").textContent = `${completenessRate}%`;

            // Mise à jour des KPI par source (se base sur le total non-filtré)
            const stPierreCount = allRawCodes.filter(c => c.source === 'borne_st_pierre').length;
            const etangSaleCount = allRawCodes.filter(c => c.source === 'borne_etang_sale').length;
            const tabletteCount = allRawCodes.filter(c => c.source === 'tablette').length;

            document.getElementById("stPierreCount").textContent = stPierreCount;
            document.getElementById("etangSaleCount").textContent = etangSaleCount;
            document.getElementById("tabletteCount").textContent = tabletteCount;

            // Afficher les statistiques par ville
            afficherStatsVilles();

            // Pagination
            displayCodes(currentPage);

            // Prépare les données pour les graphiques et les initialise
            const dataSets = preparerDonneesGraphique(allCodes);
            const sourceData = preparerDonneesSource(allRawCodes);
            initialiserGraphiques(dataSets, sourceData);
        }

        // Affiche la liste des villes avec leur nombre de saisies
        function afficherStatsVilles() {
            const villesList = document.getElementById("villes-stats-list");
            villesList.innerHTML = "";

            const villesData = {};
            allCodes.forEach(item => {
                const ville = item.ville || "Inconnu";
                villesData[ville] = (villesData[ville] || 0) + 1;
            });

            // Convertir l'objet en tableau pour le tri
            const sortedVilles = Object.keys(villesData).map(ville => ({
                ville: ville,
                count: villesData[ville]
            })).sort((a, b) => b.count - a.count);

            sortedVilles.forEach(item => {
                const li = document.createElement("li");
                li.textContent = `${item.ville}: ${item.count} saisie(s)`;
                villesList.appendChild(li);
            });
        }
        
        // Gère la pagination
        function displayCodes(page) {
            const liste = document.getElementById("listeCodes");
            liste.innerHTML = "";
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = allCodes.slice(startIndex, endIndex);

            paginatedItems.forEach(data => {
                const li = document.createElement("li");
                li.textContent = `${data.code} - ${data.ville} (${data.date?.toDate().toLocaleString()})`;
                liste.appendChild(li);
            });

            const pageInfo = document.getElementById("pageInfo");
            const totalPages = Math.ceil(allCodes.length / itemsPerPage);
            pageInfo.textContent = `Page ${page} sur ${totalPages}`;
            document.getElementById("prevPage").disabled = page <= 1;
            document.getElementById("nextPage").disabled = page >= totalPages;
        }

        // Change la page de la pagination
        window.changePage = function(offset) {
            const totalPages = Math.ceil(allCodes.length / itemsPerPage);
            const newPage = currentPage + offset;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCodes(currentPage);
            }
        }

        // Prépare les données pour les graphiques (par jour, mois, année)
        function preparerDonneesGraphique(data) {
            const dailyData = {};
            const monthlyData = {};
            const yearlyData = {};
            const villesData = {};

            data.forEach(item => {
                const date = item.date?.toDate();
                if (!date) return;
                
                const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const yearKey = `${date.getFullYear()}`;
                const ville = item.ville || "Inconnu";

                dailyData[dayKey] = (dailyData[dayKey] || 0) + 1;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                yearlyData[yearKey] = (yearlyData[yearKey] || 0) + 1;
                villesData[ville] = (villesData[ville] || 0) + 1;
            });
            
            return {
                day: { labels: Object.keys(dailyData).sort(), data: Object.values(dailyData) },
                month: { labels: Object.keys(monthlyData).sort(), data: Object.values(monthlyData) },
                year: { labels: Object.keys(yearlyData).sort(), data: Object.values(yearlyData) },
                villes: { labels: Object.keys(villesData).sort(), data: Object.values(villesData) }
            };
        }
        
        // Prépare les données pour le graphique de répartition par source
        function preparerDonneesSource(data) {
            const sourceData = {
                'Borne Saint-Pierre': 0,
                'Borne L\'Étang-Salé': 0,
                'Tablette': 0
            };
            data.forEach(item => {
                if (item.source === 'borne_st_pierre') sourceData['Borne Saint-Pierre']++;
                else if (item.source === 'borne_etang_sale') sourceData['Borne L\'Étang-Salé']++;
                else if (item.source === 'tablette') sourceData['Tablette']++;
            });
            return {
                labels: Object.keys(sourceData),
                data: Object.values(sourceData)
            };
        }

        // Initialise les graphiques
        function initialiserGraphiques(dataSets, sourceData) {
            const combinedCtx = document.getElementById('saisiesChart').getContext('2d');
            const pieCtx = document.getElementById('villesChart').getContext('2d');
            const doughnutCtx = document.getElementById('sourceChart').getContext('2d');
            
            if (myCombinedChart) myCombinedChart.destroy();
            if (myPieChart) myPieChart.destroy();
            if (myDoughnutChart) myDoughnutChart.destroy();

            myCombinedChart = new Chart(combinedCtx, {
                type: 'bar',
                data: {
                    labels: dataSets.day.labels,
                    datasets: [
                        {
                            label: 'Volume par jour',
                            data: dataSets.day.data,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)', // Bleu pour les barres
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Tendance',
                            data: dataSets.day.data,
                            type: 'line',
                            borderColor: 'rgba(46, 204, 113, 1)', // Vert pour la courbe
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: {
                            ticks: { maxRotation: 90, minRotation: 90 }
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'Évolution des Saisies', font: { size: 18 } }
                    }
                }
            });

            myPieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: dataSets.villes.labels,
                    datasets: [{
                        label: 'Saisies par ville',
                        data: dataSets.villes.data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                            '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: Math.max(12, 16 - (dataSets.villes.labels.length > 5 ? Math.floor(dataSets.villes.labels.length / 5) * 1.5 : 0))
                                }
                            }
                        },
                        title: { display: true, text: 'Répartition par Villes', font: { size: 18 } }
                    }
                }
            });
            
            myDoughnutChart = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: sourceData.labels,
                    datasets: [{
                        label: 'Saisies par source',
                        data: sourceData.data,
                        backgroundColor: [
                            '#2e7d32', '#66bb6a', '#a5d6a7'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Répartition par Source', font: { size: 18 } }
                    }
                }
            });
        }
        
        // Met à jour un graphique spécifique
        window.updateChart = function(chartId, view) {
            const dataSets = preparerDonneesGraphique(allCodes);
            
            if (chartId === 'saisiesChart') {
                const newData = dataSets[view];
                const labels = { 'day': 'Saisies par jour', 'month': 'Saisies par mois', 'year': 'Saisies par année' };
                myCombinedChart.data.labels = newData.labels;
                myCombinedChart.data.datasets[0].data = newData.data;
                myCombinedChart.data.datasets[0].label = `Volume par ${view}`;
                myCombinedChart.data.datasets[1].data = newData.data;
                myCombinedChart.data.datasets[1].label = `Tendance par ${view}`;
                myCombinedChart.update();
            } else {
                const chart = myPieChart;
                const newData = dataSets.villes;
                chart.data.labels = newData.labels;
                chart.data.datasets[0].data = newData;
                chart.options.plugins.legend.labels.font.size = Math.max(12, 16 - (newData.labels.length > 5 ? Math.floor(newData.labels.length / 5) * 1.5 : 0));
                chart.update();
            }
        }

        // Exporte les données en PDF
        window.exporterEnPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const sourceSelect = document.getElementById('sourceFilter');
            const selectedSourceText = sourceSelect.options[sourceSelect.selectedIndex].text;
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const dateRangeText = (startDate && endDate) ? `Période : du ${new Date(startDate).toLocaleDateString()} au ${new Date(endDate).toLocaleDateString()}` : "Période : Toutes les dates";

            doc.setFontSize(22);
            doc.text("Statistiques des Codes Postaux DSR", 10, 20);
            doc.setFontSize(16);
            doc.text(`Source : ${selectedSourceText}`, 10, 30);
            doc.text(dateRangeText, 10, 38);
            
            let y = 50;
            const pageMargin = 15;
            const maxWidth = doc.internal.pageSize.getWidth() - (pageMargin * 2);

            const addScaledImage = (canvas, yPos) => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const scaleFactor = maxWidth / imgWidth;
                const scaledWidth = maxWidth;
                const scaledHeight = imgHeight * scaleFactor;
                
                if (yPos + scaledHeight > doc.internal.pageSize.getHeight() - pageMargin) {
                    doc.addPage();
                    yPos = pageMargin;
                }
                
                doc.addImage(imgData, 'PNG', pageMargin, yPos, scaledWidth, scaledHeight);
                return yPos + scaledHeight + 10;
            };
            
            doc.setFontSize(14);
            doc.text("Indicateurs Clés", 10, y);
            y += 8;
            doc.text(`Total des Saisies: ${document.getElementById("totalCount").textContent}`, 10, y);
            y += 8;
            doc.text(`Villes Uniques: ${document.getElementById("uniqueCitiesCount").textContent}`, 10, y);
            y += 8;
            doc.text(`Taux de Complétude: ${document.getElementById("completenessRate").textContent}`, 10, y);
            y += 15;

            if (document.getElementById('sourceStatsSection').style.display !== 'none') {
                doc.setFontSize(18);
                doc.text("Statistiques par Source", 10, y);
                y += 10;
                doc.setFontSize(14);
                doc.text(`Saisies Borne St-Pierre: ${document.getElementById("stPierreCount").textContent}`, 10, y);
                y += 8;
                doc.text(`Saisies Borne L'Étang-Salé: ${document.getElementById("etangSaleCount").textContent}`, 10, y);
                y += 8;
                doc.text(`Saisies Tablettes: ${document.getElementById("tabletteCount").textContent}`, 10, y);
                y += 20;
                const doughnutChartCanvas = document.getElementById('sourceChart');
                y = addScaledImage(doughnutChartCanvas, y);
            }

            const combinedChartCanvas = document.getElementById('saisiesChart');
            const pieChartCanvas = document.getElementById('villesChart');
            
            y = addScaledImage(combinedChartCanvas, y);
            y = addScaledImage(pieChartCanvas, y);
            
            const villesData = {};
            allCodes.forEach(item => {
                const ville = item.ville || "Inconnu";
                villesData[ville] = (villesData[ville] || 0) + 1;
            });

            const sortedVilles = Object.keys(villesData).map(ville => ({
                ville: ville,
                count: villesData[ville]
            })).sort((a, b) => b.count - a.count);
            
            const villesTableData = sortedVilles.map(item => [item.ville, item.count]);
            
            if (y + 50 > doc.internal.pageSize.getHeight() - pageMargin) {
                doc.addPage();
                y = pageMargin;
            }

            doc.setFontSize(18);
            doc.text("Statistiques par Villes", 10, y);
            
            doc.autoTable({
                startY: y + 10,
                head: [['Ville', 'Nombre de Saisies']],
                body: villesTableData,
                theme: 'striped',
                headStyles: { fillColor: [69, 179, 157] },
                margin: { top: 10, left: 10, right: 10, bottom: 10 },
            });
            
            y = doc.autoTable.previous.finalY + 10;

            if (y + 50 > doc.internal.pageSize.getHeight() - pageMargin) {
                doc.addPage();
                y = pageMargin;
            }

            doc.setFontSize(18);
            doc.text("Derniers codes postaux enregistrés", 10, y);
            
            const tableData = allCodes.slice(0, 50).map(item => [
                item.code,
                item.ville,
                item.date?.toDate().toLocaleString(),
                item.source || 'Inconnu'
            ]);

            doc.autoTable({
                startY: y + 10,
                head: [['Code Postal', 'Ville', 'Date', 'Source']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [69, 179, 157] },
                margin: { top: 10, left: 10, right: 10, bottom: 10 },
            });
            
            const now = new Date();
            const dateStr = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0') + "-" + String(now.getHours()).padStart(2, '0') + "-" + String(now.getMinutes()).padStart(2, '0') + "-" + String(now.getSeconds()).padStart(2, '0');
            doc.save(`statistiques-codes-postaux-${dateStr}.pdf`);
        }

        // Exporte les données en CSV
        window.exporterEnCSV = function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Code Postal,Ville,Date,Source\r\n";
            
            allCodes.forEach(item => {
                const date = item.date?.toDate().toLocaleString() || "Date inconnue";
                const source = item.source || "Inconnu";
                const row = `"${item.code}","${item.ville}","${date}","${source}"`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "codes-postaux-data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

