<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Code Postaux DSR</title>
    <style>
        body { font-family: 'Inter', Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f7f9; color: #333; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input, button { padding: 12px; margin: 8px 0; font-size: 16px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s ease; }
        button:hover { background-color: #0056b3; }
        #dashboard { display: none; margin-top: 20px; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .stats-container { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0; }
        .stat-box { flex: 1; min-width: 150px; padding: 15px; border: 1px solid #e0e0e0; margin: 10px; border-radius: 12px; background-color: #fafafa; text-align: center; }
        .stat-box h3 { margin-top: 0; color: #34495e; }
        #villes-stats { text-align: left; }
        #villes-stats ul { list-style: none; padding: 0; }
        #villes-stats li { padding: 5px 0; border-bottom: 1px dotted #ccc; }
        #villes-stats li:last-child { border-bottom: none; }
        .form-section { border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px; }
        #listeCodes { list-style: none; padding: 0; }
        #listeCodes li { padding: 10px; border-bottom: 1px solid #e0e0e0; }
        #listeCodes li:last-child { border-bottom: none; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Code Postaux DSR</h1>

        <!-- Formulaire de connexion -->
        <div id="loginDiv">
            <h2>Connexion</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Mot de passe">
            <button onclick="login()">Se connecter</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="exporterEnPDF()" style="width: 48%;">Exporter en PDF</button>
                <button onclick="logout()" style="width: 48%;">Se déconnecter</button>
            </div>
            
            <hr>

            <h2>Statistiques</h2>
            <div class="stats-container">
                <div class="stat-box">
                    <h3>Total</h3>
                    <p id="totalCount"></p>
                </div>
                <div class="stat-box">
                    <h3>Aujourd'hui</h3>
                    <p id="todayCount"></p>
                </div>
                <div class="stat-box">
                    <h3>Ce mois-ci</h3>
                    <p id="monthCount"></p>
                </div>
                <div class="stat-box">
                    <h3>Cette année</h3>
                    <p id="yearCount"></p>
                </div>
            </div>
            
            <div class="stat-box" id="villes-stats">
                <h3>Totaux par villes</h3>
                <ul id="villesListe"></ul>
            </div>
            
            <hr>
            
            <h2>Graphique des Saisies</h2>
            <div>
                <label for="viewSelector">Afficher par :</label>
                <select id="viewSelector" onchange="mettreAJourGraphique(this.value)">
                    <option value="day">Jour</option>
                    <option value="month">Mois</option>
                    <option value="year">Année</option>
                </select>
                <div class="chart-container">
                    <canvas id="saisiesChart"></canvas>
                </div>
            </div>

            <hr>
            <h2>Derniers codes postaux enregistrés</h2>
            <ul id="listeCodes"></ul>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        
        // Import jsPDF pour l'exportation
        import 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        
        // Import Chart.js pour les graphiques
        import 'https://cdn.jsdelivr.net/npm/chart.js';

        // Configuration de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy3tI-gl_z0JzA7uH6bQtMc89pfFcgJMs",
            authDomain: "code-postaux-dsr.firebaseapp.com",
            projectId: "code-postaux-dsr",
            storageBucket: "code-postaux-dsr.firebasestorage.app",
            messagingSenderId: "317015321347",
            appId: "1:317015321347:web:27a95ea854064b21561736",
            measurementId: "G-25B25N3GP9"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let allCodes = []; 
        let myChart;

        // --- Fonctions d'authentification ---
        window.login = async function() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                console.error("Erreur de connexion :", err.message);
                alert("Erreur de connexion : " + err.message);
            }
        }
        
        window.logout = async function() {
            await signOut(auth);
        }

        // --- Gestion de l'état d'authentification et chargement initial ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById("loginDiv").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                const q = query(collection(db, "codesPostaux"), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    allCodes = snapshot.docs.map(doc => doc.data());
                    mettreAJourUI();
                });
            } else {
                document.getElementById("loginDiv").style.display = "block";
                document.getElementById("dashboard").style.display = "none";
            }
        });

        // --- Mise à jour de l'UI avec les données ---
        function mettreAJourUI() {
            // Charge les derniers codes postaux
            const liste = document.getElementById("listeCodes");
            liste.innerHTML = "";
            allCodes.slice(0, 20).forEach(data => {
                const li = document.createElement("li");
                li.textContent = `${data.code} - ${data.ville} (${data.date?.toDate().toLocaleString()})`;
                liste.appendChild(li);
            });

            // Calcule et affiche les statistiques
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            
            document.getElementById("totalCount").textContent = allCodes.length;
            
            const todayCount = allCodes.filter(c => c.date.toDate() >= startOfDay).length;
            const monthCount = allCodes.filter(c => c.date.toDate() >= startOfMonth).length;
            const yearCount = allCodes.filter(c => c.date.toDate() >= startOfYear).length;
            
            document.getElementById("todayCount").textContent = todayCount;
            document.getElementById("monthCount").textContent = monthCount;
            document.getElementById("yearCount").textContent = yearCount;
            
            const villesStats = allCodes.reduce((acc, current) => {
                const ville = current.ville || "Inconnu";
                acc[ville] = (acc[ville] || 0) + 1;
                return acc;
            }, {});
            
            const villesListe = document.getElementById("villesListe");
            villesListe.innerHTML = "";
            Object.entries(villesStats).sort(([, a], [, b]) => b - a).forEach(([ville, count]) => {
                const li = document.createElement("li");
                li.textContent = `${ville}: ${count}`;
                villesListe.appendChild(li);
            });

            // Prépare les données pour le graphique et l'initialise
            const dataSets = preparerDonneesGraphique();
            initialiserGraphique(dataSets);
        }
        
        // Prépare les données pour les graphiques (par jour, mois, année)
        function preparerDonneesGraphique() {
            const dailyData = {};
            const monthlyData = {};
            const yearlyData = {};

            allCodes.forEach(item => {
                const date = item.date.toDate();
                const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const yearKey = `${date.getFullYear()}`;

                dailyData[dayKey] = (dailyData[dayKey] || 0) + 1;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                yearlyData[yearKey] = (yearlyData[yearKey] || 0) + 1;
            });
            
            return {
                day: { labels: Object.keys(dailyData).sort(), data: Object.values(dailyData) },
                month: { labels: Object.keys(monthlyData).sort(), data: Object.values(monthlyData) },
                year: { labels: Object.keys(yearlyData).sort(), data: Object.values(yearlyData) }
            };
        }

        // Initialise le graphique
        function initialiserGraphique(dataSets) {
            const ctx = document.getElementById('saisiesChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar', // On utilise un graphique en barres
                data: {
                    labels: dataSets.day.labels,
                    datasets: [{
                        label: 'Saisies par jour',
                        data: dataSets.day.data,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Met à jour le graphique avec la vue sélectionnée
        window.mettreAJourGraphique = function(view) {
            const dataSets = preparerDonneesGraphique();
            const newData = dataSets[view];
            const labels = {
                'day': 'Saisies par jour',
                'month': 'Saisies par mois',
                'year': 'Saisies par année'
            };

            myChart.data.labels = newData.labels;
            myChart.data.datasets[0].data = newData.data;
            myChart.data.datasets[0].label = labels[view];
            myChart.update();
        }

        // Exporte les données en PDF
        window.exporterEnPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Statistiques des Codes Postaux DSR", 10, 20);
            
            doc.setFontSize(16);
            let y = 35;
            
            doc.text(`Total: ${document.getElementById("totalCount").textContent}`, 10, y);
            y += 10;
            doc.text(`Aujourd'hui: ${document.getElementById("todayCount").textContent}`, 10, y);
            y += 10;
            doc.text(`Ce mois-ci: ${document.getElementById("monthCount").textContent}`, 10, y);
            y += 10;
            doc.text(`Cette année: ${document.getElementById("yearCount").textContent}`, 10, y);
            y += 20;

            doc.text("Totaux par villes:", 10, y);
            y += 10;
            const villesListe = document.getElementById("villesListe").children;
            for (let i = 0; i < villesListe.length; i++) {
                doc.text(villesListe[i].textContent, 20, y);
                y += 7;
            }
            
            doc.save("statistiques-codes-postaux.pdf");
        }
    </script>
</body>
</html>

